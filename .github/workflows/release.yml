name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          generate_release_notes: true

  build-linux:
    needs: create-release
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            libasound2-dev \
            cmake \
            build-essential

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: npm ci

      - name: Clone and build whisper.cpp
        run: |
          git clone --depth 1 --branch v1.8.3 https://github.com/ggerganov/whisper.cpp.git
          cd whisper.cpp
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_VULKAN=OFF -DGGML_CUDA=OFF -DGGML_OPENCL=OFF
          cmake --build build --config Release -j$(nproc)

      - name: Build VoiceClip with Tauri
        run: npx tauri build

      - name: Download Whisper model
        run: |
          mkdir -p staging/models
          curl -L -o staging/models/base.en \
            https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en.bin

      - name: Package release archive
        run: |
          mkdir -p staging
          cp src-tauri/target/release/VoiceClip staging/
          cp whisper.cpp/build/bin/whisper-cli staging/
          chmod +x staging/VoiceClip staging/whisper-cli
          cd staging
          tar czf ../VoiceClip-linux-x86_64.tar.gz \
            --transform 's,^,VoiceClip-linux-x86_64/,' \
            VoiceClip whisper-cli models/

      - name: Upload Linux archive
        uses: softprops/action-gh-release@v2
        with:
          files: VoiceClip-linux-x86_64.tar.gz

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: npm ci

      - name: Clone and build whisper.cpp
        run: |
          git clone --depth 1 --branch v1.8.3 https://github.com/ggerganov/whisper.cpp.git
          cd whisper.cpp
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DGGML_VULKAN=OFF -DGGML_CUDA=OFF -DGGML_OPENCL=OFF
          cmake --build build --config Release

      - name: Build VoiceClip with Tauri
        run: npx tauri build

      - name: Download Whisper model
        run: |
          mkdir -p staging/models
          curl -L -o staging/models/base.en https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en.bin

      - name: Package release archive
        run: |
          cp src-tauri/target/release/VoiceClip.exe staging/
          cp whisper.cpp/build/bin/Release/whisper-cli.exe staging/
          cd staging
          Compress-Archive -Path * -DestinationPath ../VoiceClip-windows-x86_64.zip
        shell: pwsh

      - name: Upload Windows archive
        uses: softprops/action-gh-release@v2
        with:
          files: VoiceClip-windows-x86_64.zip
